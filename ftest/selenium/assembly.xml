<project name="nuxeo-assembly" default="integration-test" xmlns:nx="urn:nuxeo-build"
  xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml" uri="urn:nuxeo-artifact" />

  <target name="init" unless="init.done">
    <property name="integration.dir" value="${maven.project.build.directory}/integration" />
    <property name="selenium.dir" value="ftest/selenium" />
    <property name="jboss" value="${integration.dir}/nuxeo-ep-jboss" />
    <property name="init.done" value="true" />
  </target>

  <target name="integration-test" depends="init">
    <echo>Start integration tests...</echo>
    <antcall target="prepare-distribution" />
    <antcall target="run-selenium-tests" />
  </target>

  <target name="prepare-distribution" description="Prepare distribution to test"
    if="maven.profile.testit">
    <delete failonerror="false" dir="${jboss}" />
    <unzip dest="${integration.dir}">
      <artifact:resolveFile
        key="org.nuxeo.ecm.distribution:nuxeo-distribution-jboss:${nuxeo.version}:zip"
        classifier="nuxeo-ep" />
    </unzip>
    <rename dest="${jboss}" src="${integration.dir}/nuxeo-ep-${nuxeo.version}-jboss"/>
    <chmod dir="${jboss}/bin" perm="u+x" includes="*.sh,*ctl" />

    <copy todir="${jboss}/server/default/lib">
      <!-- copy jdbc drivers -->
      <artifact:resolveFile key="postgresql:postgresql:8.3-604.jdbc3" />
      <artifact:resolveFile key="mysql:mysql-connector-java:5.1.6" />
      <!-- copy logging monitor -->
      <artifact:resolveFile key="org.jboss.services:logging-monitor" />
    </copy>

    <copy todir="${jboss}/server/default/deploy/nuxeo.ear/plugins/"
      overwrite="true" flatten="true">
      <fileset dir="${maven.project.build.directory}">
        <include name="${maven.project.artifactId}*.jar" />
        <exclude name="*-sources.jar" />
      </fileset>
    </copy>
    <!--
      <copy todir="${jboss}/server/default/deploy/nuxeo.ear/plugins"
      overwrite="true"> <artifact:resolveFile
      key="${maven.project.groupId}:${maven.project.artifactId}:${maven.project.version}"
      /> </copy>
    -->
  </target>

  <target name="run-selenium-tests" description="Run Selenium tests">
    <copy tofile="${integration.dir}/selenium-server.jar" overwrite="false">
      <artifact:resolveFile
        key="org.seleniumhq.selenium.server:selenium-server:1.0.3" classifier="standalone" />
    </copy>
    <chmod dir="${selenium.dir}" perm="u+x" includes="*.sh,*ctl" />

    <nx:profile name="testit">
      <exec executable="${selenium.dir}/hudson-run.sh" failonerror="true">
        <arg value="${jboss}" />
        <arg value="${integration.dir}" />
      </exec>
    </nx:profile>
  </target>

</project>
