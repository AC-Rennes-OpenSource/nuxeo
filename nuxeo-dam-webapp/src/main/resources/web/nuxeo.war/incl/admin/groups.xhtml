<div xmlns:h="http://java.sun.com/jsf/html"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:a4j="http://richfaces.org/a4j">

  <script type="text/javascript">
  function confirmDeleteGroup() {
    return confirm("#{messages['label.groupManager.confirmDeleteGroup']}");
  }
  </script>

  <rich:modalPanel id="createGroupFormPanel" autosized="true"
    styleClass="CreateGroupFormPanel">
    <f:facet name="header">
      <h:panelGroup>
        <h:outputText value="#{messages['title.createGroup']}"/>
      </h:panelGroup>
    </f:facet>
    <f:facet name="controls">
      <h:panelGroup>
        <a4j:form id="createGroupHideForm">
          <a4j:commandLink
            actionListener="#{editableListBean.resetAllListsCachedModels}"
            id="createGroupHideLink"
            onclick="Richfaces.hideModalPanel('createGroupFormPanel')"
            immediate="true" reRender="createGroupPanel">
            <h:graphicImage value="/img/close.png" styleClass="hidelink" />
          </a4j:commandLink>
        </a4j:form>
      </h:panelGroup>
    </f:facet>
    <ui:include src="/incl/create_group_panel.xhtml" />
  </rich:modalPanel>

  <rich:modalPanel id="viewGroupFormPanel" autosized="true"
    styleClass="ViewGroupFormPanel">
    <f:facet name="header">
      <h:panelGroup>
        <h:outputText value="#{messages['title.editGroup']}" />
      </h:panelGroup>
    </f:facet>
    <f:facet name="controls">
      <h:panelGroup>
        <a4j:form id="viewGroupHideForm">
          <a4j:commandLink
            actionListener="#{editableListBean.resetAllListsCachedModels}"
            id="viewGroupHideLink"
            onclick="Richfaces.hideModalPanel('viewGroupFormPanel')"
            immediate="true" reRender="viewGroupPanel">
            <h:graphicImage value="/img/close.png" styleClass="hidelink" />
          </a4j:commandLink>
        </a4j:form>
      </h:panelGroup>
    </f:facet>
    <ui:include src="/incl/view_group_panel.xhtml" />
  </rich:modalPanel>

  <table cellspacing="0" cellpadding="0" border="0" style="height: 100%; width: 100%;">
    <tbody>
      <tr>
        <td valign="top" style="width: 210px;">
          <a4j:form id="groupSearchForm">
            <a4j:commandLink
              onclick="Richfaces.showModalPanel('createGroupFormPanel')"
              id="group_creation_button" reRender="createGroupPanel"
              rendered="#{groupManagerActions.allowCreateGroup and notReadOnly}">
              <h:outputText value="#{messages['command.createGroup']}" />
            </a4j:commandLink>
            <br /><br />
            <h:inputText id="groupSearchInput"
              value="#{groupManagerActions.searchString}"
              onkeydown="if(event.keyCode == 13 ||event.keyCode == 9 ){return false;}">
              <a4j:support event="onkeyup" reRender="groupSearchResult"
                requestDelay="1000" action="#{groupManagerActions.resetGroups}"
                ignoreDupResponses="true" eventsQueue="groupSearchQueue" />
            </h:inputText>
          </a4j:form>
        </td>
          <td valign="top">
          <a4j:outputPanel id="groupSearchResult">
            <h:outputText
              value="#{messages['label.groupManager.emptyGroupList']}"
              rendered="#{groupList.rowCount == 0 and groupManagerActions.searchOverflow == false and !empty groupManagerActions.searchString}" />

            <h:outputText
              value="#{messages['label.security.searchOverFlow']}"
              rendered="#{groupManagerActions.searchOverflow}" />

            <c:set var="groupSchema" value="#{userManager.groupSchemaName}" />

            <a4j:form id="groupSearchFormTab" rendered="#{groupList.rowCount > 0}">
              <h:dataTable id="GroupSearchTab" var="groupModel" value="#{groupList}"
                rowClasses="dataRowEven,dataRowOdd" styleClass="dataOutput">
                <h:column>
                  <a4j:commandLink id="delete-group"
                    action="#{groupManagerActions.deleteGroupNoRedirect()}"
                    onclick="if (!confirmDeleteGroup()) { return false; }"
                    reRender="groupSearchResult"
                    rendered="#{groupManagerActions.allowDeleteGroup and notReadOnly}">
                   <h:graphicImage value="/icons/action_delete.gif" />
                 </a4j:commandLink>
                </h:column>
                <h:column>
                  <f:facet name="header">
                      <h:outputText
                        value="#{messages['label.groupManager.groupName']}" />
                  </f:facet>
                  <a4j:commandLink
                    action="#{groupManagerActions.setSelectedGroup(groupModel)}"
                    oncomplete="Richfaces.showModalPanel('viewGroupFormPanel')"
                    reRender="viewGroupPanel">
                    <h:outputText value="#{groupModel[groupSchema].groupname}" />
                  </a4j:commandLink>
                </h:column>
                <h:column>
                  <f:facet name="header">
                    <h:outputText
                      value="#{messages['label.groupManager.userMembers']}" />
                  </f:facet>
                  <nxu:dataList value="#{userManager.getUsersInGroup(groupModel.id)}"
                       var="subGroup">
                    <h:outputText value="#{subGroup}"/>,
                  </nxu:dataList>
                </h:column>
                <h:column>
                  <f:facet name="header">
                    <h:outputText
                      value="#{messages['label.groupManager.groupMembers']}" />
                  </f:facet>
                  <nxu:dataList value="#{userManager.getGroupsInGroup(groupModel.id)}"
                       var="user">
                    <h:outputText value="#{user}" />,
                  </nxu:dataList>
                </h:column>
              </h:dataTable>
            </a4j:form>
          </a4j:outputPanel>
        </td>
      </tr>
    </tbody>
  </table>

</div>
