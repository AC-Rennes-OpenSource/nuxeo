<project name="nuxeo-assembly"
         default="build"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />
  <artifact:expand depth="2" />

  <property name="outdir" value="${maven.project.build.directory}" />
  <property name="stagedir" value="${outdir}/stage" />


  <target name="build">
    <echo>Building Tomcat distribution...</echo>
    <property name="tomcat" value="${stagedir}/nuxeo-dam-tomcat" />
    <property name="nxserver" value="${tomcat}/nxserver" />

    <mkdir dir="${stagedir}" />
    <!-- Extract Tomcat -->
    <unzip dest="${stagedir}">
      <artifact:resolveFile key="org.apache.tomcat:apache-tomcat:6.0.20:zip" />
    </unzip>
    <nx:rename from="${stagedir}/apache-tomcat*" to="${tomcat}" />
    <!-- patch catalina.sh to add custom JAVA properties -->
    <replace file="${tomcat}/bin/catalina.sh">
      <replacetoken>#!/bin/sh</replacetoken>
      <replacevalue><![CDATA[#!/bin/sh

JAVA_OPTS="$JAVA_OPTS -Xms128m -Xmx512m -XX:MaxPermSize=256m -Dfile.encoding=UTF-8"

]]>
      </replacevalue>
    </replace>
    <replace file="${tomcat}/bin/catalina.bat">
      <replacetoken>@echo off</replacetoken>
      <replacevalue><![CDATA[@echo off

set JAVA_OPTS=%JAVA_OPTS% -Xms128m -Xmx512m -XX:MaxPermSize=256m -Dfile.encoding=UTF-8

]]>
      </replacevalue>
    </replace>
    <chmod dir="${tomcat}/bin" perm="750" includes="*.sh" />

    <!-- Extract Nuxeo webapp -->
    <unzip dest="${tomcat}">
      <artifact:resolveFile key="org.nuxeo.dam.distribution:nuxeo-dam-distribution-jetty:${maven.project.version}:zip" />
    </unzip>
    <nx:rename from="${tomcat}/nuxeo-*" to="${nxserver}" />

    <!-- Custom resources -->
    <copy todir="${tomcat}" overwrite="true">
      <fileset dir="src/main/resources" />
    </copy>
    <delete>
      <fileset dir="${nxserver}/config" includes="webbindings-config.xml" />
      <fileset dir="${nxserver}/config" includes="jetty.xml" />
      <fileset dir="${nxserver}/config" includes="default-web.xml" />
    </delete>

    <!-- Cleanup and reorganize libraries -->
    <delete>
      <fileset dir="${nxserver}" includes="nuxeo-runtime-launcher-*" />
      <fileset dir="${nxserver}/bundles" includes="nuxeo-runtime-jetty-*" />
      <!--fileset dir="${nxserver}/bundles" includes="nuxeo-runtime-deploy-*" /-->
      <!--fileset dir="${nxserver}/bundles" includes="nuxeo-platform-virtualnavigation-*" /-->
      <fileset dir="${nxserver}/lib" includes="core-*" />
      <!-- jetty-util is needed by jsp impl jar - whic is referring jetty log classes -->
      <fileset dir="${nxserver}/lib"
               includes="jetty-*"
               excludes="jetty-util*" />
      <fileset dir="${nxserver}/lib" includes="jsp-api*" />
      <fileset dir="${nxserver}/lib" includes="servlet-api-*" />
      <fileset dir="${nxserver}/lib" includes="el-api*" />
      <fileset dir="${nxserver}/lib" includes="jsp-*" />
    </delete>
    <!-- we need el-ri impl in lib - why this is not part of jetty distrib? -->
    <copy todir="${nxserver}/lib">
      <artifact:resolveFile key="com.google.gwt:gwt-servlet:1.7.0:jar" />
      <artifact:resolveFile key="jstl:jstl:1.1.2:jar" />
      <artifact:resolveFile key="javax.el:el-ri:unknown:jar" />
    </copy>

    <!--echo>Running nuxeo build processor</echo>
    <nx:preprocess src="${nxserver}" /-->

    <copy todir="${tomcat}/lib">
      <artifact:resolveFile key="org.nuxeo.runtime:nuxeo-runtime-tomcat-adapter:${nuxeo.runtime.version}:jar" />
    </copy>
    <!-- we need to move DS related jars into tomcat lib ... The move must be done after running the processing since it is depending on these jars -->
    <move todir="${tomcat}/lib">
      <fileset dir="${nxserver}/lib" includes="derby-*" />
      <fileset dir="${nxserver}/lib" includes="h2-*" />
      <fileset dir="${nxserver}/lib" includes="log4j-*" />
      <fileset dir="${nxserver}/lib" includes="lucene-*" />
      <fileset dir="${nxserver}/lib" includes="commons-logging-*" />
      <fileset dir="${nxserver}/lib" includes="commons-lang-*" />
      <fileset dir="${nxserver}/lib" includes="freemarker-*" />
      <fileset dir="${nxserver}/bundles"
               includes="nuxeo-core-storage-sql-extensions-*" />
      <fileset dir="${nxserver}/bundles"
               includes="nuxeo-generic-wss-handler-*" />
    </move>

    <!-- TODO do the same for windows cmd file -->

    <!-- NXP-4361 - provide transaction management and pooling support for Tomcat -->
    <copy todir="${nxserver}/lib">
      <artifact:resolveFile key="org.apache.geronimo.components:geronimo-connector:2.1.3" />
      <artifact:resolveFile key="org.apache.geronimo.components:geronimo-transaction:2.1.3" />
      <artifact:resolveFile key="org.objectweb.howl:howl:1.0.1-1" />
    </copy>
    <copy todir="${nxserver}/bundles">
      <artifact:file groupId="org.nuxeo.runtime"
                     artifactId="nuxeo-runtime-jtajca" />
      <artifact:file groupId="org.nuxeo.ecm.core"
                     artifactId="nuxeo-core-storage-sql-ra"
                     type="jar" />
    </copy>

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}.zip"
         basedir="${stagedir}"
         includes="nuxeo-dam-tomcat/**"/>
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}.zip"
                     type="zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}" />

  </target>

  <target name="clean">
    <delete dir="${stagedir}" />
  </target>

  <target name="cleanall">
    <delete dir="${outdir}" />
  </target>

</project>
