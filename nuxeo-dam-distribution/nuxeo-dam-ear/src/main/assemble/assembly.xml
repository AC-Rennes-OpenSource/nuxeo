<project name="nuxeo-assembly" default="build" xmlns:nx="urn:nuxeo-build"
  xmlns:artifact="urn:nuxeo-artifact">

  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
    uri="urn:nuxeo-artifact" />

  <target name="init" unless="init.done">
    <condition property="no.alternate.build">
      <isset property="maven.profile.vcs" />
    </condition>

    <property name="outdir" value="${maven.project.build.directory}" />
    <property name="stagedir" value="${outdir}/stage" />
    <property name="finaltarget" value="../target" />
    <antcall target="cleanoutput" />

    <antcall target="expand" />
    <property name="init.done" value="true" />

  </target>

  <target name="expand">
    <artifact:expand depth="3" />
    <!--<artifact:print output="dependency-tree.log" />-->
  </target>

  <target name="build" depends="init">
    <echo>Building DAM EAR</echo>
    <property name="nuxeo.ear" value="${stagedir}/nuxeo.ear" />
    <mkdir dir="${nuxeo.ear}" />

    <antcall target="build-standard" />
    <delete failonerror="false" dir="${outdir}/nuxeo.ear" />
    <copy todir="${finaltarget}/nuxeo.ear">
      <fileset dir="${nuxeo.ear}" />
    </copy>

    <antcall target="cleanstage" />
  </target>

  <target name="build-standard" description="Build default distribution"
    depends="init">

    <unzip dest="${nuxeo.ear}">
      <artifact:resolveFile
        key="org.nuxeo.ecm.distribution:nuxeo-distribution-dm:${nuxeo.distribution.version}:zip" />
    </unzip>

    <copy todir="${nuxeo.ear}" overwrite="true">
      <artifact:file artifactId="nuxeo-dam-webapp" />
      <artifact:file artifactId="nuxeo-dam-webapp-core" />
    </copy>
    <copy todir="${nuxeo.ear}/system" overwrite="true">
      <artifact:set>
        <includes>
          <artifact groupId="org.nuxeo.dam*" />
          <artifact artifactId="nuxeo-platform-video-core" />
          <artifact artifactId="nuxeo-platform-video-jsf" />
          <artifact artifactId="nuxeo-platform-video-convert" />
          <artifact artifactId="nuxeo-platform-audio-core" />
          <artifact artifactId="nuxeo-platform-categorization-service" />
          <artifact artifactId="nuxeo-platform-categorization-language" />
          <artifact artifactId="nuxeo-platform-categorization-coverage" />
          <artifact artifactId="nuxeo-platform-categorization-subjects" />
        </includes>
        <excludes>
          <artifact artifactId="nuxeo-dam-webapp" />
          <artifact artifactId="nuxeo-dam-webapp-core" />
        </excludes>
      </artifact:set>
    </copy>

    <delete>
      <fileset dir="${nuxeo.ear}">
        <include name="nuxeo-platform-webapp*" />
      </fileset>

      <fileset dir="${nuxeo.ear}/system">
        <include name="nuxeo-platform-virtualnavigation-web*" />
        <include name="nuxeo-platform-forum*" />
        <include name="nuxeo-platform-syndication*" />
        <include name="nuxeo-platform-publish*" />
        <include name="nuxeo-platform-comment-web*" />
        <include name="nuxeo-platform-workflow*" />
        <include name="nuxeo-platform-imaging-dm*" />
        <include name="nuxeo-platform-directory-web*" />
        <include name="nuxeo-platform-lang*" />
        <include name="nuxeo-platform-tag*" />
        <include name="nuxeo-platform-mail*" />
        <include name="nuxeo-platform-ear*" />
        <include name="nuxeo-platform-wss*" />
        <include name="nuxeo-platform-spaces*" />
        <include name="nuxeo-platform-virtualnavigation*" />

        <include name="nuxeo-opensocial*" />

        <include name="nuxeo-webengine-gadgets*" />
        <include name="nuxeo-webengine-admin*" />
        <include name="nuxeo-webengine-blogs*" />
        <include name="nuxeo-webengine-sites*" />
        <include name="nuxeo-webengine-ui*" />
      </fileset>

      <fileset dir="${nuxeo.ear}/lib">
        <include name="shindig*" />
        <include name="oauth*" />
        <include name="caja*" />
      </fileset>
    </delete>

    <antcall target="third-party-libraries" />

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}.zip"
       basedir="${nuxeo.ear}" />

    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}.zip"
       target="${maven.project.groupId}:${maven.project.artifactId}"
       type="zip" />

  </target>

  <target name="third-party-libraries">
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <artifact:resolveFile key="de.schlichtherle.io:truezip" />
    </copy>
  </target>

  <target name="cleanstage">
    <delete dir="${stagedir}" />
  </target>

  <target name="cleanoutput">
    <delete dir="${finaltarget}" />
  </target>

</project>
