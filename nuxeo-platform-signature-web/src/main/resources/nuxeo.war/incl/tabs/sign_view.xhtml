<div xmlns="http://www.w3.org/1999/xhtml"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:t="http://myfaces.apache.org/tomahawk"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxd="http://nuxeo.org/nxweb/document"
  xmlns:nxh="http://nuxeo.org/nxweb/html"
  xmlns:nxdir="http://nuxeo.org/nxdirectory"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:nxl="http://nuxeo.org/nxforms/layout"><a4j:outputPanel
  id="signPanel">

  <div id="facesStatusMessage" class="facesStatusMessage"><h:messages
    globalOnly="true" infoClass="infoFeedback"
    warnClass="warningFeedback" errorClass="errorFeedback" /></div>

  <h:form>
    <h:commandLink action="#{certActions.downloadRootCertificate}"
      immediate="true">
      <h:outputText value="#{messages['command.root.certificate.download']}" />
    </h:commandLink>
  </h:form>

  <c:if test="#{signActions.isPDFSigned()}">

    <table class="dataInput">
      <tbody>
        <tr>
          <td class="labelColumn"><h:outputText
            value="#{messages['label.sign.document.signed']}" /></td>
        </tr>
        <tr>
          <td class="fieldColumn"><h:outputText
            value="#{signActions.getPDFCertificateInfo()}" /></td>
        </tr>
      </tbody>
    </table>

  </c:if>

  <c:if test="#{!signActions.isPDFSigned()}">

    <c:if test="#{certActions.hasCertificate()}">

      <table class="dataInput">
        <tbody>
          <tr>
            <td class="labelColumn"><h:outputText
              value="#{messages['label.sign.prompt']}" /></td>
            <td class="fieldColumn"><nxh:outputLink
              class="boldLabel"
              value="#{nxd:fileUrl('downloadFile', currentDocument, 'blobholder:0', currentDocumentAsBlobHolder.blob.filename)}">
              <nxh:graphicImage
                value="#{nxd:fileIconPath(currentDocumentAsBlobHolder.blob)}"
                rendered="#{! empty nxd:fileIconPath(currentDocumentAsBlobHolder.blob)}" />
              <h:outputText
                value="#{currentDocumentAsBlobHolder.blob.filename}" />
              <nxh:graphicImage value="/icons/download.png"
                title="#{label.root.certificate.download}" />
            </nxh:outputLink></td>
          </tr>
        </tbody>
      </table>

      <a4j:form id="sign_form" ajaxSingle="true"
        enctype="multipart/form-data"
        rendered="#{certActions.hasCertificate()}">
        <table class="dataInput">
          <tbody>
            <tr>
              <td class="labelColumn"><h:outputText
                value="#{messages['label.sign.reason']}" /></td>
              <td class="fieldColumn"><h:inputText
                id="signingReason" value="#{signingReason}"
                required="true" /></td>
            </tr>
            <tr>
              <td class="labelColumn"><h:outputText
                value="#{messages['label.sign.password']}" /></td>
              <td class="fieldColumn"><h:inputSecret id="password"
                value="#{password}" required="true" rendered="true" />

              </td>
            </tr>
            <tr>
              <td></td>
              <td class="fieldColumn"><a4j:commandButton
                id="SignPDF" styleClass="button"
                value="#{messages['label.sign.submit']}"
                action="#{signActions.signCurrentDoc(signingReason,password)}"
                onclick=""
                data="#{facesContext.maximumSeverity.ordinal ge 2}"
                oncomplete="if (data) { hideWaiter() } else { processFinished() };"
                reRender="signPanel" /></td>
            </tr>
          </tbody>
        </table>
      </a4j:form>
    </c:if>
  </c:if>

  <c:if test="#{!certActions.hasCertificate()}">
    <h:outputText value="#{messages['label.sign.certificate.prompt']}" />
    <h:form>
      <h:outputText
        value="#{userManagerActions.setSelectedUser(userManager.getUserModel(currentUser.name))}" />
      <h:commandLink action="#{userManagerActions.viewUser}"
        immediate="true">
        <h:outputText value="#{messages['label.cert.navigate']}" />
      </h:commandLink>
    </h:form>
  </c:if>

</a4j:outputPanel></div>