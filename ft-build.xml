<?xml version="1.0"?>
<project name="ft" default="usage" basedir=".">
  <target name="usage">
    <echo message="usage: ant" />
    <echo message="run-ft                 => run all" />
    <echo
      message="get-nuxeo-distribution => download from mercurial the nuxeo-distribution project" />
    <echo
      message="make-distribution      => create a jboss with nuxeo from nuxeo-distribution" />
    <echo message="deploy-project         => deploy the project into JBoss" />
    <echo message="start-jboss            => start JBoss server" />
    <echo message="run-selenium           => run the selenium test" />
    <echo message="stop-jboss             => stop the JBoss server" />
  </target>
  <target name="run-ft"
    depends="make-distribution,deploy-project,start-jboss,run-selenium,stop-jboss"
    description="Build Jboss, deploy Nuxeo DAM, start JBoss, run functional tests, stop JBoss.">
  </target>
  <target name="get-nuxeo-distribution">
    <delete dir="nuxeo-distribution" failonerror="false" />
    <exec executable="hg" failonerror="true">
      <arg value="clone" />
      <arg value="http://hg.nuxeo.org/nuxeo/nuxeo-distribution#5.2" />
    </exec>
  </target>
  <target name="make-distribution" depends="get-nuxeo-distribution"
    description="Build JBoss with Nuxeo EAR">
    <exec executable="mvn" failonerror="true">
      <arg value="clean" />
      <arg value="install" />
      <arg value="-Pnuxeo-ep-jboss" />
      <arg value="-f" />
      <arg value="nuxeo-distribution/pom.xml" />
    </exec>
  </target>
  <target name="deploy-project" description="Deploy Nuxeo DAM EAR into JBoss">
    <ant target="deploy" dir="${basedir}">
      <property name="jboss.dir"
        value="${basedir}/nuxeo-distribution/nuxeo-distribution-jboss/target/jboss" />
    </ant>
  </target>
  <target name="start-jboss">
    <chmod perm="+x"
      file="${basedir}/nuxeo-distribution/nuxeo-distribution-jboss/target/jboss/bin/run.sh" />
    <exec
      executable="${basedir}/nuxeo-distribution/nuxeo-distribution-jboss/target/jboss/bin/run.sh"
      spawn="true">
      <arg value="start" />
    </exec>
    <waitfor>
      <http url="http://localhost:8080/nuxeo/login.jsp" />
    </waitfor>
  </target>
  <target name="run-selenium">
    <exec executable="./nuxeo-dam-ear/ftest/selenium/run.sh" />
  </target>
  <target name="stop-jboss">
    <chmod perm="+x"
      file="${basedir}/nuxeo-distribution/nuxeo-distribution-jboss/target/jboss/bin/shutdown.sh" />
    <exec
      executable="${basedir}/nuxeo-distribution/nuxeo-distribution-jboss/target/jboss/bin/shutdown.sh"
      failonerror="true">
      <arg value="-S" />
    </exec>
  </target>
</project>
