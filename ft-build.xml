<?xml version="1.0"?>
<project name="ft" default="usage" basedir=".">

  <property name="pom.file" value="${basedir}/nuxeo-dam-distribution/pom.xml" />
  <property name="mvn.profiles" value="NXP" />

  <target name="usage">
    <echo message="usage: ant" />
    <echo message="run-ft                        => run all" />
    <echo message="make-distribution             => make Nuxeo DAM JBoss distribution" />
    <echo message="make-tomcat-distribution      => make Nuxeo DAM Tomcat distribution" />
    <echo message="start-jboss                   => start JBoss server" />
    <echo message="start-tomcat                  => start Tomcat server" />
    <echo message="run-selenium                  => run the selenium test" />
    <echo message="stop-jboss                    => stop the JBoss server" />
    <echo message="stop-tomcat                   => stop the Tomcat server" />
  </target>

  <target name="run-ft"
    depends="start-jboss,run-selenium,stop-jboss"
    description="start JBoss, run functional tests, stop JBoss.">
  </target>

  <target name="run-ft-tomcat"
    depends="start-jboss,run-selenium,stop-jboss"
    description="start JBoss, run functional tests, stop JBoss.">
  </target>

  <target name="make-distribution">
    <exec executable="mvn" failonerror="true">
      <arg value="-f" />
      <arg value="${pom.file}" />
      <arg value="clean" />
      <arg value="package" />
      <arg value="install" />
      <arg value="-P" />
      <arg value="jboss" />
      <arg value="-P" />
      <arg value="${mvn.profiles}" />
    </exec>
  </target>

  <target name="make-tomcat-distribution">
    <exec executable="mvn" failonerror="true">
      <arg value="-f" />
      <arg value="${pom.file}" />
      <arg value="clean" />
      <arg value="package" />
      <arg value="install" />
      <arg value="-P" />
      <arg value="tomcat" />
      <arg value="-P" />
      <arg value="${mvn.profiles}" />
    </exec>
  </target>

  <target name="start-jboss">
    <chmod perm="+x"
      file="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-jboss/target/nuxeo-dam-jboss/bin/jbossctl" />
    <exec
      executable="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-jboss/target/nuxeo-dam-jboss/bin/jbossctl">
      <arg value="start" />
    </exec>
    <waitfor>
      <http url="http://localhost:8080/nuxeo/login.jsp" />
    </waitfor>
  </target>

  <target name="stop-jboss">
    <chmod perm="+x"
      file="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-jboss/target/nuxeo-dam-jboss/bin/jbossctl" />
    <exec
      executable="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-jboss/target/nuxeo-dam-jboss/bin/jbossctl">
      <arg value="stop" />
    </exec>
  </target>

  <target name="start-tomcat">
    <chmod perm="+x"
      dir="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-tomcat/target/nuxeo-dam-tomcat/bin" includes="**/*.sh"/>
    <exec
      executable="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-tomcat/target/nuxeo-dam-tomcat/bin/startup.sh">
    </exec>
    <waitfor>
      <http url="http://localhost:8080/nuxeo/login.jsp" />
    </waitfor>
  </target>

  <target name="stop-tomcat">
    <exec
      executable="${basedir}/nuxeo-dam-distribution/nuxeo-dam-distribution-tomcat/target/nuxeo-dam-tomcat/bin/shutdown.sh">
    </exec>
  </target>

  <target name="run-selenium">
    <exec executable=".${basedir}/nuxeo-dam-distribution/nuxeo-dam-ear/ftest/selenium/run.sh" />
  </target>

</project>
