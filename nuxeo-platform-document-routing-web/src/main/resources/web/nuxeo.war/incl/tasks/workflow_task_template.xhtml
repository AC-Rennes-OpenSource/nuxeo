<div xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:nxh="http://nuxeo.org/nxweb/html"
  xmlns:nxl="http://nuxeo.org/nxforms/layout"
  xmlns:nxd="http://nuxeo.org/nxweb/document">
<c:if test="false">
Displays a 'task' or a 'dashboardItem' object if the task was not created by the workflow.
@since 5.7.3 
</c:if>

  <nxu:set var="idPrefix" value="task_#{task.id}" cache="true">
    <nxu:valueHolder id="#{idPrefix}_valueHolder" var="actionClicked"
      defaultValue="false">
      <f:subview id="#{idPrefix}_subview_process_task"
        rendered="#{!showFirstForm}">
        <a4j:commandButton id="#{idPrefix}_link_cancel"
          value="#{messages['label.document.routing.cancel.task']}"
          ajaxSingle="true" ignoreDupResponses="true" requestDelay="100"
          styleClass="button smallButton floatR"
          reRender="#{idPrefix}_ajax_panel">
          <f:setPropertyActionListener value="false"
            target="#{selectionActions.selectedValue}" />
          <f:setPropertyActionListener value="#{idPrefix}_valueHolder"
            target="#{selectionActions.selectedValueHolder}" />
          <nxu:actionListenerMethod value="#{selectionActions.onClick}" />
        </a4j:commandButton>
        <a4j:commandButton id="#{idPrefix}_link"
          value="#{messages['label.document.routing.process.task']}"
          ajaxSingle="true" ignoreDupResponses="true" requestDelay="100"
          styleClass="button smallButton floatR"
          reRender="#{idPrefix}_ajax_panel">
          <f:setPropertyActionListener value="true"
            target="#{selectionActions.selectedValue}" />
          <f:setPropertyActionListener value="#{idPrefix}_valueHolder"
            target="#{selectionActions.selectedValueHolder}" />
          <nxu:actionListenerMethod value="#{selectionActions.onClick}" />
        </a4j:commandButton>
      </f:subview>


      <f:subview id="#{idPrefix}_subview">

        <table class="dataTable">
          <tbody>
            <tr>
              <td class="labelColumn"><h:outputText
                  value="#{messages['label.route.task.workflowStep']}" /></td>
              <td class="fieldColumn"><h:outputText
                  value="#{messages[routingActions.getRouteInstanceFor(task).title]} - #{messages[task.name]}" />
              </td>
            </tr>
            <tr>
              <td class="labelColumn"><h:outputText
                  value="#{messages['label.route.task.assigned.to']}" /></td>
              <td class="fieldColumn"><c:forEach var="actor"
                  items="#{task.actors}">
                  <nxl:widgetType name="template" mode="view"
                    template="/document_routing_widgets/route_assignee_widget_template.xhtml"
                    value="#{actor}" />
                </c:forEach></td>
            </tr>
            <tr>
              <td class="labelColumn"><h:outputText
                  value=" #{messages['label.route.task.due.date']} " /></td>
              <td class="fieldColumn dueDate warningLabel"><h:outputText
                  value="#{task.dueDate}" /></td>
            </tr>
            <tr>
              <td class="labelColumn"><h:outputText
                  value="#{messages['label.review.directive']}" /></td>
              <td class="fieldColumn"><h:outputText
                  value="#{messages[task.directive]}" /></td>
            </tr>
          </tbody>
        </table>

      </f:subview>

      <a4j:outputPanel id="#{idPrefix}_ajax_panel" layout="block">
        <c:if test="#{actionClicked or showFirstForm}">
          <div>
            <div id="#{idPrefix}_box">
              <nxu:set var="isRoutingTask"
                value="#{routingTaskActions.isRoutingTask(task)}">
                <c:if test="#{isRoutingTask}">
                  <nxl:layout
                    name="#{routingTaskActions.getTaskLayout(task)}"
                    mode="edit"
                    value="#{routingTaskActions.getFormVariables(task)}" />
                  <p class="buttonsGadget">
                    <nxu:set var="actions"
                      value="#{routingTaskActions.getTaskButtons(task)}"
                      cache="true">
                      <nxu:dataList var="btn_action" value="#{actions}"
                        id="#{idPrefix}_versionActionsTable">
                        <span id="#{sel_action.id}"> <h:commandLink
                            action="#{routingTaskActions.endTask(task)}"
                            value="#{messages[btn_action.label]}"
                            styleClass="button smallButton">
                            <f:param name="button"
                              value="#{btn_action.id}" />
                          </h:commandLink>
                        </span>
                      </nxu:dataList>
                    </nxu:set>
                  </p>
                </c:if>

                <c:if test="#{not isRoutingTask}">
                  <h4>#{dashboardItem.i18nTaskName}</h4>
                  <table class="dataInput">
                    <tr>
                      <td class="labelColumn"><h:outputText
                          class="required"
                          value="#{messages['label.review.user.comment']}" /></td>
                      <td><h:inputTextarea
                          id="#{widget.id}_taskActionComment" rows="5"
                          cols="50" value="#{taskActions.comment}" /></td>
                    </tr>
                    <tr>
                      <td colspan="6"><h:message
                          styleClass="errorMessage"
                          for="#{widget.id}_taskActionComment" /></td>
                    </tr>
                  </table>
                  <p class="buttonsGadget">
                    <h:commandLink
                      value="#{messages['label.review.end.task']}"
                      styleClass="button smallButton"
                      action="#{taskActions.acceptTask(dashboardItem.task)}"
                      rendered="#{taskService.canEndTask(currentUser, dashboardItem.task)}" />
                    <a4j:commandLink
                      value="#{messages['label.review.reject.task']}"
                      styleClass="button smallButton"
                      action="#{taskActions.rejectTask(dashboardItem.task)}"
                      rendered="#{taskService.canEndTask(currentUser, dashboardItem.task)}"
                      reRender="#{widget.id}_panel"
                      onclick="jQuery.fancybox.close();" />
                  </p>
                </c:if>
              </nxu:set>
            </div>
          </div>
        </c:if>
      </a4j:outputPanel>
    </nxu:valueHolder>
  </nxu:set>
</div>